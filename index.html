<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="version" content="v12">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Weekly Timesheet</title>

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <!-- PWA manifest -->
  <link rel="manifest" href="manifest.json">

  <!-- iOS icons -->
  <link rel="apple-touch-icon" sizes="120x120" href="helix-120.png">
  <link rel="apple-touch-icon" sizes="152x152" href="helix-152.png">
  <link rel="apple-touch-icon" sizes="167x167" href="helix-167.png">
  <link rel="apple-touch-icon" sizes="180x180" href="helix-180.png">

  <style>
    :root {
      --bg: #f5f5f5;
      --card-bg: #ffffff;
      --accent: #0057b8;
      --text-main: #222;
      --text-muted: #666;
      --border: #ddd;
    }

    body {
      margin: 0;
      padding: 0;
      background: var(--bg);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    .app {
      max-width: 900px;
      margin: 0 auto;
      padding: 16px;
    }

    h1 {
      text-align: center;
      margin-bottom: 4px;
    }

    .subtitle {
      text-align: center;
      color: var(--text-muted);
      margin-bottom: 16px;
    }

    .name-field {
      margin-bottom: 16px;
      text-align: center;
    }

    .name-field input {
      width: 90%;
      max-width: 300px;
      height: 34px;
      padding: 6px 10px;
      font-size: 1rem;
      border: 1px solid var(--border);
      border-radius: 6px;
    }

    .week-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .week-nav-group {
      display: flex;
      gap: 8px;
    }

    button {
      padding: 6px 10px;
      border-radius: 6px;
      border: 1px solid var(--accent);
      background: var(--accent);
      color: #fff;
      cursor: pointer;
    }

    button.secondary {
      background: #fff;
      color: var(--accent);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .week-status {
      text-align: center;
      margin-bottom: 10px;
      color: var(--text-muted);
    }

    .week-status .tag {
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      font-size: 0.75rem;
      margin-left: 4px;
      cursor: default;
    }

    .tag.editable {
      border-color: var(--accent);
      color: var(--accent);
      background: #e0ecff;
      cursor: pointer;
    }

    .tag.locked {
      background: #eee;
      color: #777;
    }

    table.week-table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      border-radius: 10px;
      overflow: hidden;
    }

    .week-table th,
    .week-table td {
      border-bottom: 1px solid var(--border);
      padding: 10px;
      vertical-align: top;
    }

    .day-cell {
      width: 22%;
    }

    .time-loc-cell {
      width: 58%;
    }

    .hours-cell {
      width: 20%;
      text-align: right;
      font-weight: 600;
      vertical-align: top;
      padding-top: 4px;
    }

    .day-wrap {
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      padding-top: 4px;
      height: 70px;
    }

    .day-label {
      font-size: 0.9rem;
      font-weight: 600;
    }

    .day-date {
      font-size: 0.75rem;
      color: #777;
      margin-top: 2px;
    }

    .time-row {
      display: flex;
      gap: 6px;
      margin-bottom: 4px;
    }

    .time-row input {
      flex: 1;
      height: 30px;
      padding: 4px 6px;
      font-size: 0.9rem;
    }

    .location-row input {
      width: 100%;
      height: 30px;
      padding: 4px 6px;
      font-size: 0.9rem;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      margin-top: 16px;
      font-size: 1rem;
    }

    .total-hours {
      font-weight: 700;
    }

    @media (max-width: 480px) {
      .day-wrap {
        height: 64px;
      }

      .time-row input,
      .location-row input {
        height: 28px;
        font-size: 0.85rem;
      }
    }
  </style>
</head>

<body>
<div class="app">

  <h1>Weekly Timesheet</h1>
  <div class="subtitle">Weeks run Monday to Sunday.</div>

  <div class="name-field">
    <input id="employeeName" type="text" placeholder="Enter your name">
  </div>

  <div class="week-header">
    <div class="week-nav-group">
      <button id="prevWeekBtn" class="secondary">&laquo; Previous</button>
    </div>
    <div id="weekLabel"></div>
    <div class="week-nav-group">
      <button id="nextWeekBtn" class="secondary">Next &raquo;</button>
    </div>
  </div>

  <div id="weekStatus" class="week-status"></div>

  <table class="week-table">
    <thead>
      <tr>
        <th>Day</th>
        <th>Times & Location</th>
        <th>Hours</th>
      </tr>
    </thead>
    <tbody id="weekTableBody"></tbody>
  </table>

  <div class="summary-row">
    <div>Total hours this week:</div>
    <div class="total-hours" id="totalHours">0.00</div>
  </div>

  <button id="emailBtn" style="margin-top:16px; width:100%;">Email Timesheet</button>

  <div id="versionIndicator" style="text-align:center; margin-top:12px; color:#888; font-size:0.8rem;">
    Version v12
  </div>

</div>

<script>
const APP_VERSION = "v12";

function toTitleCase(str) {
  return str
    .toLowerCase()
    .split(" ")
    .filter(s => s.length > 0)
    .map(s => s[0].toUpperCase() + s.slice(1))
    .join(" ");
}

const nameInput = document.getElementById("employeeName");

function updateEmailButtonState() {
  const name = nameInput.value.trim();
  const emailBtn = document.getElementById("emailBtn");
  emailBtn.disabled = (name.length === 0);
}

document.getElementById("versionIndicator").textContent = `Version ${APP_VERSION}`;

/* NAME FIELD STORAGE */
nameInput.value = localStorage.getItem("employeeName") || "";
nameInput.value = toTitleCase(nameInput.value);
updateEmailButtonState();

nameInput.addEventListener("input", () => {
  const formatted = toTitleCase(nameInput.value);
  nameInput.value = formatted;
  localStorage.setItem("employeeName", formatted);
  updateEmailButtonState();
});

/* UTILITIES */
function getMonday(date) {
  const d = new Date(date);
  const day = d.getDay();
  const diff = (day === 0 ? -6 : 1 - day);
  d.setDate(d.getDate() + diff);
  d.setHours(0,0,0,0);
  return d;
}

function addDays(date, days) {
  const d = new Date(date);
  d.setDate(d.getDate() + days);
  return d;
}

function formatDateUK(date) {
  const d = String(date.getDate()).padStart(2,"0");
  const m = String(date.getMonth()+1).padStart(2,"0");
  const y = date.getFullYear();
  return `${d}/${m}/${y}`;
}

function formatISO(date) {
  return date.toISOString().split("T")[0];
}

function parseTimeToMinutes(t) {
  if (!t) return null;
  const [h,m] = t.split(":").map(Number);
  return h*60 + m;
}

function getWeekKey(mondayDate) {
  return formatISO(mondayDate);
}

/* CONSTANTS */
const dayNames = ["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];
const todayMonday = getMonday(new Date());
let currentMonday = getMonday(new Date());

/* WEEK RELATION */
function getWeekRelation(weekMonday) {
  const thisTime = weekMonday.getTime();
  const currentTime = todayMonday.getTime();
  const prevMonday = addDays(todayMonday, -7).getTime();

  if (thisTime === currentTime) return "current";
  if (thisTime === prevMonday) return "previous";
  if (thisTime < prevMonday) return "older";
  return "future";
}

/* STORAGE HELPERS */
function loadWeekData(weekMonday) {
  const key = "timesheet-" + getWeekKey(weekMonday);
  const raw = localStorage.getItem(key);
  if (!raw) return {};
  try { return JSON.parse(raw) || {}; } catch { return {}; }
}

function saveWeekData(weekMonday, data) {
  const key = "timesheet-" + getWeekKey(weekMonday);
  localStorage.setItem(key, JSON.stringify(data));
}

function getLockInfo(weekMonday) {
  const baseKey = getWeekKey(weekMonday);
  const relation = getWeekRelation(weekMonday);

  const emailedKey = "timesheet-emailed-" + baseKey;
  const unlockKey = "timesheet-unlock-" + baseKey;

  const emailed = localStorage.getItem(emailedKey) === "true";
  const manualUnlock = localStorage.getItem(unlockKey) === "true";

  const isOlder = (relation === "older");
  let locked;

  if (isOlder) locked = true;
  else {
    if (emailed && !manualUnlock) locked = true;
    else locked = false;
  }

  return { relation, emailed, manualUnlock, locked, emailedKey, unlockKey };
}

function setEmailed(weekMonday, value) {
  const key = "timesheet-emailed-" + getWeekKey(weekMonday);
  localStorage.setItem(key, value ? "true" : "false");
}

function setManualUnlock(weekMonday, value) {
  const key = "timesheet-unlock-" + getWeekKey(weekMonday);
  localStorage.setItem(key, value ? "true" : "false");
}

/* RENDER WEEK */
function renderWeek() {
  const tbody = document.getElementById("weekTableBody");
  tbody.innerHTML = "";

  const weekStart = new Date(currentMonday);
  const weekEnd = addDays(weekStart, 6);

  document.getElementById("weekLabel").textContent =
    `${formatDateUK(weekStart)} – ${formatDateUK(weekEnd)}`;

  const weekData = loadWeekData(currentMonday);
  const lockInfo = getLockInfo(currentMonday);
  const locked = lockInfo.locked;

  updateWeekStatus(lockInfo);

  for (let i = 0; i < 7; i++) {
    const date = addDays(currentMonday, i);
    const dayName = dayNames[i];
    const iso = formatISO(date);

    const dayRecord = (weekData[iso] || { start:"", finish:"", location:"", hours:null });

    const tr = document.createElement("tr");
    tr.dataset.date = iso;

    const dayTd = document.createElement("td");
    dayTd.className = "day-cell";
    dayTd.innerHTML = `
      <div class="day-wrap">
        <span class="day-label">${dayName}</span>
        <span class="day-date">${formatDateUK(date)}</span>
      </div>
    `;
    tr.appendChild(dayTd);

    const timeLocTd = document.createElement("td");
    timeLocTd.className = "time-loc-cell";
    timeLocTd.innerHTML = `
      <div class="time-row">
        <input type="time" class="start-time">
        <input type="time" class="finish-time">
      </div>
      <div class="location-row">
        <input type="text" class="location-input" placeholder="Enter site location">
      </div>
    `;
    tr.appendChild(timeLocTd);

    const hoursTd = document.createElement("td");
    hoursTd.className = "hours-cell";
    hoursTd.innerHTML = `<span class="hours-value">–</span>`;
    tr.appendChild(hoursTd);

    tbody.appendChild(tr);

    const startInput = tr.querySelector(".start-time");
    const finishInput = tr.querySelector(".finish-time");
    const locationInput = tr.querySelector(".location-input");
    const hoursSpan = tr.querySelector(".hours-value");

    if (dayRecord.start) startInput.value = dayRecord.start;
    if (dayRecord.finish) finishInput.value = dayRecord.finish;
    if (dayRecord.location) locationInput.value = dayRecord.location;
    if (typeof dayRecord.hours === "number") {
      hoursSpan.textContent = dayRecord.hours.toFixed(2);
    }

    function recalc() {
      if (locked) return;

      const s = startInput.value;
      const f = finishInput.value;
      const loc = locationInput.value.trim();

      let hours = null;

      if (!s || !f || !loc) {
        hoursSpan.textContent = "–";
      } else {
        const sm = parseTimeToMinutes(s);
        const fm = parseTimeToMinutes(f);

        if (fm > sm) {
          const diff = (fm - sm) / 60;
          hours = diff;
          hoursSpan.textContent = diff.toFixed(2);
        } else {
          hoursSpan.textContent = "–";
        }
      }

      weekData[iso] = {
        start: startInput.value || "",
        finish: finishInput.value || "",
        location: locationInput.value || "",
        hours: (hours !== null ? hours : null)
      };
      saveWeekData(currentMonday, weekData);
      updateTotal();
    }

    startInput.addEventListener("change", recalc);
    finishInput.addEventListener("change", recalc);
    locationInput.addEventListener("input", recalc);

    if (locked) {
      startInput.disabled = true;
      finishInput.disabled = true;
      locationInput.disabled = true;
    }
  }

  updateTotal();
}

/* WEEK STATUS UI */
function updateWeekStatus(lockInfo) {
  const statusEl = document.getElementById("weekStatus");
  const { relation, locked } = lockInfo;

  let label;
  if (relation === "current") label = "Current week";
  else if (relation === "previous") label = "Previous week";
  else if (relation === "older") label = "Older week";
  else label = "Future week";

  const tagClass = locked ? "tag locked" : "tag editable";
  const tagText = locked ? "Locked" : "Editable";

  statusEl.innerHTML = `
    <span>${label}</span>
    <span id="lockTag" class="${tagClass}">${tagText}</span>
  `;

  const lockTag = document.getElementById("lockTag");

  lockTag.addEventListener("click", () => {
    const info = getLockInfo(currentMonday);
    if (info.relation === "older") return;
    if (!info.emailed) return;

    const newManual = !info.manualUnlock;
    setManualUnlock(currentMonday, newManual);
    renderWeek();
  });
}

/* TOTAL HOURS */
function updateTotal() {
  let total = 0;
  document.querySelectorAll(".hours-value").forEach(span => {
    const n = parseFloat(span.textContent);
    if (!isNaN(n)) total += n;
  });
  document.getElementById("totalHours").textContent = total.toFixed(2);
}

/* EMAIL EXPORT */
function buildEmailBody() {
  const lines = [];
  const weekStart = new Date(currentMonday);
  const weekEnd = addDays(weekStart, 6);

  lines.push(`Timesheet for week ${formatDateUK(weekStart)} to ${formatDateUK(weekEnd)}`);
  lines.push("");

  const weekData = loadWeekData(currentMonday);

  for (let i = 0; i < 7; i++) {
    const date = addDays(currentMonday, i);
    const iso = formatISO(date);
    const dayName = dayNames[i];
    const rec = weekData[iso];

    if (!rec || !rec.start || !rec.finish || typeof rec.hours !== "number") continue;

    const loc = rec.location ? ` (${rec.location})` : "";
    const line = `${dayName} ${rec.start}–${rec.finish}${loc} = ${rec.hours.toFixed(2)}`;
    lines.push(line);
  }

  lines.push("");
  lines.push(`Total hours: ${document.getElementById("totalHours").textContent}`);

  return lines.join("\n");
}

function emailCurrentWeek() {
  const weekStart = new Date(currentMonday);
  const weekEnd = addDays(weekStart, 6);

  const name = (nameInput.value || "").trim();
  const nameSuffix = name ? ` – ${name}` : "";

  const subject = `Timesheet – ${formatDateUK(weekStart)} to ${formatDateUK(weekEnd)}${nameSuffix}`;
  const body = buildEmailBody();

  const recipients = "mike@helixgroup.uk,alex@helixgroup.uk";

  const mailto = `mailto:${encodeURIComponent(recipients)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;

  setEmailed(currentMonday, true);
  setManualUnlock(currentMonday, false);

  window.location.href = mailto;

  setTimeout(renderWeek, 100);
}

/* NAVIGATION */
document.getElementById("prevWeekBtn").addEventListener("click", () => {
  currentMonday = addDays(currentMonday, -7);
  renderWeek();
});

document.getElementById("nextWeekBtn").addEventListener("click", () => {
  currentMonday = addDays(currentMonday, 7);
  renderWeek();
});

document.getElementById("emailBtn").addEventListener("click", emailCurrentWeek);

/* INITIAL RENDER */
renderWeek();

/* SERVICE WORKER REGISTRATION */
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("service-worker.js");
  });
}
</script>

</body>
</html>
